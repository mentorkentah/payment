<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LUMIEARN Payment</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
<style>
body{margin:0;padding:0;font-family:Arial,sans-serif;background:#f5f7fa;display:flex;justify-content:center;align-items:center;min-height:100vh;}
.pay-card{background:#fff;width:380px;padding:25px;border-radius:16px;box-shadow:0 8px 25px rgba(0,0,0,0.3);text-align:center;}
.logo{width:350px;margin-bottom:10px;}
h2{margin:10px 0 5px;color:#0050ff;}
.sub{font-size:13px;color:#333;margin-bottom:15px;}
.amount-box{background:#e6f0ff;border:2px dashed #0050ff;border-radius:12px;padding:15px;margin:15px 0;}
.amount-box span{display:block;font-size:14px;color:#333;}
.amount{font-size:26px;font-weight:bold;color:#0050ff;}
.phone{font-size:14px;margin-top:6px;color:#333;}
.notice{background:#fff3cd;color:#856404;font-size:12px;padding:10px;border-radius:10px;margin-bottom:15px;font-weight:bold;text-align:left;}
.btn{width:100%;height:45px;border:none;border-radius:12px;background:#0050ff;color:#fff;font-size:15px;font-weight:bold;cursor:pointer;margin-bottom:10px;}
.btn:hover{background:#003bb5;}
.payment-methods{display:flex;gap:10px;margin-bottom:15px;}
.payment-methods button{flex:1;padding:12px;border:none;border-radius:12px;cursor:pointer;font-weight:bold;display:flex;align-items:center;justify-content:center;gap:6px;font-size:14px;}
.mpesa{background:#ffba00;color:#000;}
.airtel{background:#e60000;color:#fff;}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);justify-content:center;align-items:center;z-index:9999;}
.modal-content{background:#fff;padding:20px;border-radius:16px;width:90%;max-width:400px;text-align:left;position:relative;}
.modal-content h3{margin-top:0;color:#0050ff;}
.modal-content pre{background:#f5f5f5;padding:10px;border-radius:8px;overflow-x:auto;}
.copy-btn{margin-top:10px;padding:6px 12px;background:#0050ff;color:#fff;border:none;border-radius:8px;cursor:pointer;}
.close-btn{position:absolute;top:10px;right:10px;cursor:pointer;font-size:18px;color:#0050ff;}
</style>
</head>
<body>

<div class="pay-card">
  <img src="https://lumiearn.vercel.app/logo.png" class="logo" alt="LUMIEARN">
  <h2>Activate Your Account</h2>
  <p class="sub">Send the amount below to complete activation</p>

  <div class="amount-box">
    <span>Activation Fee</span>
    <div class="amount" id="activationAmount">KES 0</div>
    <div class="phone" id="paymentPhone">+000000000</div>
  </div>

  <div class="notice">
    • One-time payment<br>
    • Unlocks full dashboard<br>
    • Referral commission credited instantly
  </div>

  <div class="payment-methods">
    <button class="mpesa" id="mpesaBtn"><i class="fa-solid fa-mobile-screen-button"></i> MPESA</button>
    <button class="airtel" id="airtelBtn"><i class="fa-solid fa-mobile-screen-button"></i> Airtel</button>
  </div>

  <button class="btn" id="payApiBtn"><i class="fa-solid fa-lock"></i> Pay Full via MPESA</button>

</div>

<!-- MPESA Modal -->
<div class="modal" id="mpesaModal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal('mpesaModal')">&times;</span>
    <h3>MPESA Payment Procedure</h3>
    <pre id="mpesaProcedure">Step 1: Go to M-PESA → Paybill → Enter Till: 4560832 → Amount: KES X → Account: Username</pre>
    <button class="copy-btn" onclick="copyTill('4560832')">Copy Till</button>
  </div>
</div>

<!-- Airtel Modal -->
<div class="modal" id="airtelModal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal('airtelModal')">&times;</span>
    <h3>Airtel Payment Procedure</h3>
    <pre id="airtelProcedure">Step 1: Go to Airtel Money → Paybill → Enter Till: 123456 → Amount: KES X → Account: Username</pre>
    <button class="copy-btn" onclick="copyTill('123456')">Copy Till</button>
  </div>
</div>

<script>
const activationAmount = document.getElementById("activationAmount");
const paymentPhone = document.getElementById("paymentPhone");

// Example: fetch registered user from localStorage
const username = localStorage.getItem("LUMIEARN_LOGGED_IN");
if(!username){ alert("Please login"); window.location.href="login.html"; }
const userKey = "LUMIEARN_USER_" + username.toLowerCase();
const userData = JSON.parse(localStorage.getItem(userKey));
if(!userData){ alert("User not found"); window.location.href="login.html"; }

// Set dynamic amount & phone
activationAmount.textContent = "KES " + userData.capitalFee;
paymentPhone.textContent = userData.phone;

// Modal handling
function closeModal(id){ document.getElementById(id).style.display='none'; }
document.getElementById("mpesaBtn").onclick = ()=> document.getElementById("mpesaModal").style.display='flex';
document.getElementById("airtelBtn").onclick = ()=> document.getElementById("airtelModal").style.display='flex';
function copyTill(till){ navigator.clipboard.writeText(till); alert("Till copied: "+till); }

// API MPESA Push
document.getElementById("payApiBtn").onclick = async ()=>{
  const payload = {
    username: userData.username,
    phone: userData.phone,
    amount: userData.capitalFee,
    till: "4560832",
    callbackUrl: window.location.origin + "/api/mpesa-callback"
  };

  try{
    const res = await fetch("/api/mpesa-push", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(data.success){
      alert("MPESA push sent! Follow instructions on your phone.");
    } else {
      alert("Payment failed: "+data.message);
    }
  }catch(e){
    alert("Network error: "+e.message);
  }
};
</script>
</body>
</html>