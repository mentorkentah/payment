<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Activate Account | LUMIEARN</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

<style>
html,body{
margin:0;padding:0;min-height:100vh;display:flex;
justify-content:center;align-items:center;
font-family:Arial, Helvetica, sans-serif;
background:linear-gradient(135deg,#0a3f99,#0050ff);
}
.pay-card{
background:#fff;width:360px;max-width:92%;
padding:25px 20px;border-radius:16px;
box-shadow:0 8px 25px rgba(0,0,0,0.3);
text-align:center;
}
.logo{width:300px;margin-bottom:10px;}
h2{margin:10px 0 5px;color:#0050ff;}
.sub{font-size:13px;color:#333;margin-bottom:15px;}
.amount-box{
background:#e6f0ff;border:2px dashed #0050ff;
border-radius:12px;padding:15px;margin:15px 0;
}
.amount{font-size:26px;font-weight:bold;color:#0050ff;}
.phone{font-size:14px;margin-top:6px;color:#333;}
.notice{
background:#fff3cd;color:#856404;
font-size:12px;padding:10px;
border-radius:10px;margin-bottom:15px;
font-weight:bold;text-align:left;
}
.btn{
width:100%;height:45px;border:none;
border-radius:12px;background:#0050ff;
color:#fff;font-size:15px;font-weight:bold;
cursor:pointer;margin-top:10px;
}
.btn:hover{background:#003bb5;}
.loading{
display:none;margin-top:10px;
font-size:13px;font-weight:bold;color:#0050ff;
}
.secure{margin-top:12px;font-size:12px;color:#555;}
.secure i{color:#0050ff;margin-right:5px;}
</style>
</head>

<body>

<div class="pay-card">
  <img src="https://lumiearn.vercel.app/logo.png" class="logo">
  <h2>Activate Your Account</h2>
  <p class="sub">Send the amount below to complete activation</p>

  <div class="amount-box">
    <div class="amount" id="activationAmount">KES 0</div>
    <div class="phone" id="paymentPhone">+000000000</div>
  </div>

  <div class="notice">
    • One-time payment<br>
    • Unlocks full dashboard<br>
    • Referral commission credited instantly
  </div>

  <button class="btn" id="payBtn">
    <i class="fa-solid fa-lock"></i> Pay with M-Pesa
  </button>

  <div class="loading" id="loadingText">
    Processing payment, please approve on your phone...
  </div>

  <div class="secure">
    <i class="fa-solid fa-shield-halved"></i>
    Secure payment confirmation
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function(){

  const username = localStorage.getItem("LUMIEARN_LOGGED_IN");
  if(!username){ window.location.href="index.html"; return; }

  const userKey = "LUMIEARN_USER_" + username.toLowerCase();
  let userData = JSON.parse(localStorage.getItem(userKey));

  if(!userData){ 
    alert("User not found"); 
    window.location.href="index.html"; 
    return; 
  }

  if(userData.paid){
    window.location.href="dashboard.html";
    return;
  }

  document.getElementById("activationAmount").textContent =
    "KES " + userData.capitalFee;

  document.getElementById("paymentPhone").textContent =
    userData.phone;

  document.getElementById("payBtn").addEventListener("click", async ()=>{

    document.getElementById("loadingText").style.display = "block";

    try{

      const response = await fetch("/api/mpesa", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          username: userData.username,
          phone: userData.phone,
          amount: userData.capitalFee
        })
      });

      const data = await response.json();

      if(!data.success){
        alert("Payment request failed. Try again.");
        document.getElementById("loadingText").style.display="none";
        return;
      }

      // Start checking payment status every 5 seconds
      const interval = setInterval(async ()=>{

        const check = await fetch(
          "/api/check-status?username=" + userData.username
        );

        const result = await check.json();

        if(result.paid){
          clearInterval(interval);

          userData.paid = true;
          localStorage.setItem(userKey, JSON.stringify(userData));

          alert("Payment successful! Redirecting...");
          window.location.href="dashboard.html";
        }

      }, 5000);

    }catch(err){
      alert("Payment server not reachable.");
      document.getElementById("loadingText").style.display="none";
    }

  });

});
</script>

</body>
</html>